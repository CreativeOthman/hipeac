{% extends 'layout.html' %}

{% load compress %}
{% load static %}


{% block head_title %}The Network - {{ block.super }}{% endblock %}

{% block subtitle %}{{ flatpage.title }}{% endblock %}

{% block submenu %}
    <li class="nav-item">
        <router-link :to="{name: 'paper-awards'}" class="nav-link">Paper Awards</router-link>
    </li>
{% endblock %}

{% block content %}
    <div id="urls" data-publication-conference-list="{% url 'v1:publication-conference-list' %}" data-paper-award-list="{% url 'v1:paper-award-list' %}" class="container">
        <router-view></router-view>
    </div>
{% endblock %}

{% block vue_templates %}
    {% include './v-paper-awards.html' with id='v-paper-awards' blck=flatpage.page.tbs.paper_awards %}
{% endblock %}

{% block scripts %}
{% compress js inline %}
    <script>
        var Store = new Vuex.Store({
            state: {
                conferences: []
            },
            mutations: {
                fetchConferences: function (state) {
                    ajax().get($('#urls').data('publication-conference-list')).done(function (res) {
                        state.conferences = res;
                    });
                }
            },
            getters: {
                years: function (state) {
                    if (!state.conferences) return null;
                    return _.keys(_.groupBy(state.conferences, 'year')).sort().reverse();
                },
                confs: function (state) {
                    if (!state.conferences) return null;
                    return _.uniq(_.pluck(state.conferences, 'acronym'), function (obj) {
                        return obj.value;
                    }).sort(function (a, b) {
                        return sortText(a.value, b.value);
                    });;
                }
            }
        });

        var PaperAwardsView = {
            template: '#v-paper-awards',
            props: ['year'],
            data: function () {
                return {
                    paperAwards: []
                };
            },
            computed: _.extend(
                Vuex.mapGetters(['years', 'confs']), {
                selectedPaperAwards: function () {
                    if (!this.paperAwards || !this.year) return [];
                    return _.groupBy(this.paperAwards, 'conference');
                }
            }),
            methods: {
                fetchPaperAwards: function () {
                    var self = this;
                    ajax().get($('#urls').data('paper-award-list'), {year: this.year}).done(function (res) {
                        self.paperAwards = res;
                    });
                },
                redirect: function () {
                    var self = this;

                    if (!this.years.length) {
                        setTimeout(function () { self.redirect(); }, 25);
                        return;
                    }

                    this.$router.push({
                        name: 'paper-awards',
                        params: {
                            year: +this.years[0],
                        }
                    });
                }
            },
            watch: {
                'year': function (val, oldVal) {
                    if (val) this.fetchPaperAwards();
                }
            },
            created: function () {
                this.$store.commit('fetchConferences');
            },
            mounted: function () {
                if (!this.year) this.redirect();
                else this.fetchPaperAwards();
            }
        };

        var Router = new VueRouter({
            linkActiveClass: 'active',
            routes: [
                {
                    path: '/',
                    redirect: { name: 'paper-awards' }
                },
                {
                    name: 'paper-awards',
                    path: '/paper-awards/:year?/',
                    pathToRegexpOptions: {strict: true},
                    component: PaperAwardsView,
                    props: true
                }
            ]
        });

        var app = new Vue({
            el: '#vue',
            store: Store,
            router: Router
        });
    </script>
{% endcompress %}
{% endblock %}
