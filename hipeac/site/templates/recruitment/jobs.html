{% extends 'layout.html' %}

{% load compress %}
{% load static %}


{% block head_title %}Jobs - {{ block.super }}{% endblock %}

{% block subtitle %}{{ flatpage.title }}{% endblock %}

{% block submenu %}
    <li class="nav-item">
        <router-link :to="{name: 'about'}" class="nav-link">About</router-link>
    </li>
    <li class="nav-item">
        <router-link :to="{name: 'jobs'}" class="nav-link" exact>Open positions</router-link>
    </li>
    <li class="nav-item">
        <router-link :to="{name: 'careerCenter'}" class="nav-link">Career center</router-link>
    </li>
    <li class="nav-item">
        <router-link :to="{name: 'internships'}" class="nav-link">Internship programme</router-link>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="https://twitter.com/hipeacjobs" target="_blank"><span is="twitter-icon"></span></a>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="https://www.hipeac.net/linkedin/" target="_blank"><span is="linkedin-icon"></span></a>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="{% url 'jobs_feed' %}" target="_blank"><i class="material-icons">&#xE0E5;</i></a>
    </li>
{% endblock %}

{% block content %}
    <div id="urls" data-job-list="{% url 'v1:job-list' %}" class="container">
        <router-view></router-view>
    </div>
{% endblock %}

{% block vue_templates %}
    {% include './v-about.html' with id='v-about' display=flatpage.content blck=flatpage.page.tbs.about recruiters=flatpage.page.tbs.about_recruiters students=flatpage.page.tbs.about_students %}
    {% include './v-career-center.html' with id='v-career-center' blck=flatpage.page.tbs.career_center %}
    {% include './v-internships.html' with id='v-internships' %}
    {% include './v-jobs.html' with id='v-jobs' %}
{% endblock %}

{% block scripts %}
    <script src="{% static 'vendor/jcarousel@0.3.8/jquery.jcarousel.min.js' %}"></script>
{% compress js inline %}
    <script>
        Vue.component('jobs-carousel', {
            props: ['jobs'],
            template: '' +
                '<div v-if="institutions.length">' +
                    '<div ref="carousel" class="carousel-logos">' +
                        '<ul>' +
                            '<li v-for="institution in institutions" :key="institution.id">' +
                                '<span :style="{\'background-image\': \'url( \'+ institution.images.md + \')\' }"></span>' +
                            '</li>' +
                        '</ul>' +
                    '</div>' +
                '</div>' +
                '<loading v-else></loading>' +
            '',
            computed: {
                institutions: function () {
                    if (!this.jobs) [];

                    return _.shuffle(_.reject(_.uniq(_.pluck(this.jobs, 'institution'), function (obj) {
                        return obj.id;
                    }), function (obj) {
                        return obj.images == null;
                    }));
                }
            },
            methods: {
                initCarousel: function () {
                    $(this.$refs.carousel).jcarousel({
                        auto: 0.001,
                        transforms3d: true,
                        animation: {
                            duration: 2500,
                            easing: 'linear',
                        }
                    }).jcarouselAutoscroll({
                        interval: 0
                    });
                }
            },
            watch: {
                'institutions': function (val, oldVal) {
                    if (!oldVal) return;

                    setTimeout(function () {
                        this.initCarousel();
                    }.bind(this), 50);
                }
            },
            mounted: function () {
                if (this.institutions) {
                    this.initCarousel();
                }
            }
        });
    </script>
    <script>
        var Store = new Vuex.Store({
            state: {
                jobs: []
            },
            mutations: {
                fetchJobs: function (state) {
                    ajax().get($('#urls').data('job-list')).done(function (res) {
                        state.jobs = mapper().jobs(res);
                    });
                }
            }
        });

        var AboutView = {
            template: '#v-about',
            computed: _.extend(
                Vuex.mapState(['jobs']), {
            })
        };

        var CareerCenterView = {
            template: '#v-career-center'
        };

        var InternshipsView = {
            template: '#v-internships'
        };

        var JobsView = {
            template: '#v-jobs',
            data: function () {
                return {
                    q: ''
                }
            },
            computed: _.extend(
                Vuex.mapState(['jobs']), {
                filteredIds: function () {
                    return _.pluck(filterMultiple(this.jobs, this.q), 'id');
                }
            }),
            methods: {
                updateQuery: function (val) {
                    this.q = val;
                }
            },
            created: function () {
                EventHub.$on('query-changed', this.updateQuery);
            }
        };

        var Router = new VueRouter({
            linkActiveClass: 'active',
            routes: [
                {
                    name: 'about',
                    path: '/recruitment/',
                    pathToRegexpOptions: {strict: true},
                    component: AboutView
                },
                {
                    name: 'careerCenter',
                    path: '/career-center/',
                    pathToRegexpOptions: {strict: true},
                    component: CareerCenterView
                },
                {
                    name: 'internships',
                    path: '/internships/',
                    pathToRegexpOptions: {strict: true},
                    component: InternshipsView
                },
                {
                    name: 'jobs',
                    path: '/',
                    pathToRegexpOptions: {strict: true},
                    component: JobsView
                }
            ]
        });

        var app = new Vue({
            el: '#vue',
            store: Store,
            router: Router,
            created: function () {
                $.when(
                    this.$store.commit('fetchJobs')
                );
            }
        });
    </script>
{% endcompress %}
{% endblock %}
